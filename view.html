<html>
    <script>
        var user = "";
        var token = "";
        var currPage;
        var pageSize = 3;
        var searchRes;
        var collectionList = new Map();
        // {
        //     "收藏夹名":{
        //         "链接1的文本":"链接1的url","链接2的文本":"链接2的url"
        //     },
        //     "1":{
        //         "sd":"jjjj","sdd":"jjjkk"
        //     },
        //     "第二个":{
        //         "sd":"jkljkl","sdfsdfsf":"kljl"
        //     }
        // };
        var collection = "";
        function useAlert(errCode){
            switch(errCode){
                case 1001:
                    alert("ERROR_USERNAME_USED");
                    break;
                case 1002:
                    alert("ERROR_PASSWORD_WRONG");
                    break;
                case 1003:
                    alert("ERROR_USER_NOT_EXIST");
                    break;
                case 1004:
                    alert("ERROR_TOKEN_EXIST");
                    break;
                case 1005:
                    alert("ERROR_TOKEN_RUNTIME");
                    break;
                case 1006:
                    alert("ERROR_TOKEN_WRONG");
                    break;
                case 1007:
                    alert("ERROR_TOKEN_TYPE");
                    break;
                case 2001:
                    alert("ERROR_LINKNAME_USED");
                    break;
                case 3001:
                    alert("ERROR_FAVORITENAME_USED");
                    break;
            }
        }
        function changePage(page){
            document.getElementById(currPage).setAttribute('class','');
            document.getElementById(page).setAttribute('class','active');
            currPage = page;
            flushSearch();
        }
        function flushSearch(){
            document.getElementById("content").innerHTML = "";
            for(i=0;i<pageSize;i++){
                if(currPage*pageSize+i>=searchRes.length){
                    break;
                }
                // searchRes[i] = ("<a target=\"_blank\"href="+idx[i].ImgUrl+">"+idx[i].Text + "<br />");
                document.getElementById("content").innerHTML += "<a target=\"_blank\"href="+searchRes[currPage*pageSize+i].ImgUrl+">"+searchRes[currPage*pageSize+i].Text+"<br/>";
            }
        }
        function flushUser(){
            if(user == ""){
                document.getElementById("usrName").innerText="未登录";
                document.getElementById("usrName").style.color = "red";
                document.getElementById("login").innerText='登录';
                document.getElementById("register").innerText="注册";
                document.getElementById("register").onclick = showRightUpBox;
            }
            else{
                document.getElementById("usrName").innerText=user;
                document.getElementById("usrName").style.color = "blue";
                document.getElementById("login").innerText='切换/退出';
                document.getElementById("register").innerText="注销";
                document.getElementById("register").onclick = dropUserName;
            }
        }
        function flushFav(){
            if(user==""){
                document.getElementById("collection").style.display = "none";
                return;
            }
            document.getElementById("collection").style.display = "block";
            document.getElementById("collectionInner").innerHTML = "";
            if(collection == ""){//查看收藏夹列表
                for(let [key,value] of collectionList){
                    document.getElementById("collectionInner").innerHTML += '<div style="height:30px;"><a id="favNameQ+'+key+'" style="overflow:hidden; white-space:nowrap;text-overflow:ellipsis;height:25px;width:350px;display:block;float:left;" onclick="goToFav(this.id)">'+key+'</a><input type="submit" id="favNameD+'+key+'" value="删除" style="height:24px;" size="2" onclick="deleteFav(this.id)"></div><hr style="background-color: #2a14ee;height: 1px; border: none;">';
                }
                document.getElementById("collectionBack").style.display = "none";
                document.getElementById("collectionBtn").onclick = addFav;
                document.getElementById("collectionAddText").placeholder = "新的收藏夹名";
            }
            else{//查看某个收藏夹
                let theMap = collectionList.get(collection);
                for(let [key,value] of theMap){
                    document.getElementById("collectionInner").innerHTML += '<div style="height:30px;"><a id="lnkNameQ+'+key+'" style="overflow:hidden; white-space:nowrap;text-overflow:ellipsis;height:25px;width:350px;display:block;float:left;" target=\"_blank\" href="'+value+'">'+key+'</a><input type="submit" id="lnkNameD+'+key+'" value="删除" style="height:24px;" size="2" onclick="deleteLnk(this.id)"></div><hr style="background-color: #2a14ee;height: 1px; border: none;">';
                }
                document.getElementById("collectionBack").style.display = "block";
                document.getElementById("collectionBtn").onclick = addLnk;
                document.getElementById("collectionAddText").placeholder = "收藏链接的序号";
            }

        }
        function dropUserName(){
            var xhr = new XMLHttpRequest();

            xhr.open("delete", "/user/"+user);
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send(null)
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            user = "";
                            token = "";
                            flushUser();
                            getFav();
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
            document.getElementById("inputUserName").value="";
            document.getElementById("inputPWD").value="";
            document.getElementById("rightupBox").style.display="none";
        }
        function loginOrQuit(){
            if(user!=""){
                let uN = document.getElementById("inputUserName").value;
                if(uN == ""){
                    document.getElementById("loginBtn").value="退出";
                }
                else{
                    document.getElementById("loginBtn").value="登录";
                }
            }
        }
        function showRightUpBox(registerORlogin){
            if(user != "" && document.getElementById("inputUserName").value==""){
                document.getElementById("loginBtn").value="退出";
            }
            else if(registerORlogin == "login"){
                document.getElementById("loginBtn").value="登录";
            }
            else{
                document.getElementById("loginBtn").value="注册";
            }
            document.getElementById("rightupBox").style.display="block";
        }
        function getFav(){
            if(user == ""){
                document.getElementById("collection").style.display = "none";
            }
            var xhr = new XMLHttpRequest();

            xhr.open("get", "/favo/favos");
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send(null)
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            collectionList = new Map();
                            for(let key in obj.data){
                                collectionList.set(obj.data[key].name,new Map());
                                getLnk(obj.data[key].name);
                            }
                            flushFav();
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
        }
        function goToFav(favName){
            collection = favName.slice(9);
            flushFav();
        }
        function deleteFav(favName){
            var xhr = new XMLHttpRequest();
            favName = favName.slice(9);
            xhr.open("delete", "/favo/"+favName);
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send(null)
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        console.log(obj);
                        if(obj.status == 200){
                            document.getElementById("collectionAddText").value = "";
                            console.log("to get Fav");
                            getFav();
                            console.log("deleteFav,success");
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
        }
        function favBack(){
            collection = "";
            flushFav();
        }
        function addFav(){
            var xhr = new XMLHttpRequest();
            let favName = document.getElementById("collectionAddText").value;
            if(favName == ""){
                alert("请输入收藏夹名");
                return;
            }
            xhr.open("post", "/favo/add");
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send('{"name":"'+favName+'"}')
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            document.getElementById("collectionAddText").value = "";
                            getFav();
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
        }
        function addLnk(){
            var xhr = new XMLHttpRequest();
            let linkId = document.getElementById("collectionAddText").value;
            if(Number(currPage*pageSize) + Number(linkId) > searchRes.length || linkId > pageSize){
                alert("请输入正确的序号");
                return;
            }
            let link = searchRes[Number(currPage*pageSize) + Number(linkId)-1];
            // let tmpText = link.Text;
            let tmpText = "";
            for(let i = 0; i<link.Text.length; i++){
                if(link.Text[i]=='"'){
                    tmpText += '\\';
                }
                tmpText += link.Text[i];
            }

            xhr.open("post", "/link/add");
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send('{"title":"'+tmpText+'","favoritename":"'+collection+'","content":"'+link.ImgUrl+'"}')
            xhr.onreadystatechange=state_Change;
            console.log('{"title":"'+link.Text+'","favoritename":"'+collection+'","content":"'+link.ImgUrl+'"}');
            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            document.getElementById("collectionAddText").value = "";
                            getFav();
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
        }
        function getLnk(favName){
            var xhr = new XMLHttpRequest();
            xhr.open("get", "/link/list/"+favName);
            xhr.setRequestHeader('Authorization','Bearer '+token);
            xhr.timeout = 2000;
            xhr.send(null)
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            for(let data of obj.data){
                                collectionList.get(data.favoritename).set(data.title,data.content);
                            }
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                }
            }
        }
        function login(){
            let method = document.getElementById("loginBtn").value;
            if(method == "退出"){
                user = "";
                document.getElementById("rightupBox").style.display="none";
                flushUser();
                getFav();
                return;
            }

            var usrName = document.getElementById("inputUserName").value;
            var pwd = document.getElementById("inputPWD").value;

            if(usrName == ""){
                alert("请输入用户名");
                return;
            }
            if(usrName.includes("/")){
                alert("用户名不能含有'/'");
                return;
            }
            if(pwd == ""){
                alert("请输入密码");
                return;
            }
            if(pwd.includes("/")){
                alert("密码不能含有'/'");
                return;
            }

            var xhr = new XMLHttpRequest();
            if(method=="登录"){
                xhr.open("post", "/user/login");
                xhr.timeout = 2000;
                xhr.send('{"username":"'+usrName+'","password":"'+pwd+'"}')
            }
            else{//注册
                xhr.open("post", "/user/add");
                xhr.timeout = 2000;
                xhr.send('{"username":"'+usrName+'","password":"'+pwd+'"}')
            }
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret);
                        if(obj.status == 200){
                            if(method == "登录"){
                                user = usrName;
                                token = obj.token;
                                getFav();
                            }
                            cancelLogin();
                            flushUser();
                        }
                        else{
                            useAlert(obj.status);
                        }
                    }
                    else{
                        alert("Problem retrieving XML data:" + this.status);
                    }
                }
            }
        }
        function cancelLogin(){
            document.getElementById("inputUserName").value="";
            document.getElementById("inputPWD").value="";
            document.getElementById("rightupBox").style.display="none";
        }
        function updateMethod(theMethod){
            if(theMethod == "default"){
                document.getElementById("input").innerText = "!!!!!!";
                console.log("!!!");
            }
            else{
                document.getElementById("input").innerHTML = "";
                console.log("???");
            }
        }
        function searching(){
            time = "time";
            text = document.getElementById("input").value;
            var xhr = new XMLHttpRequest();

            // 每次需要发请求需要做两步：
            xhr.open("get", "http://localhost:8080/"+time+"/"+text, true);
            xhr.timeout = 2000;
            xhr.send(null)
            xhr.onreadystatechange=state_Change;

            function state_Change(){
                if (this.readyState==4){// 4 = "loaded"
                    if (this.status==200){// 200 = "OK"
                        let ret = xhr.responseText;
                        let obj = JSON.parse(ret)

                        var i;
                        var idx = obj.ReturnRes;
                        searchRes = new Array(idx.length)
                        for (var i=0;i<idx.length;i++){
                            searchRes[i] = idx[i];
                        }
                        document.getElementById("pagelist").innerHTML = '<li><a id="0" class= "active" onclick="changePage(this.id)" href="#">1</a></li>'
                        for(var i=1;i<Math.ceil(idx.length/pageSize);i++){
                            document.getElementById("pagelist").innerHTML += '<li><a id="'+ i +'" onclick="changePage(this.id)" href="#">'+(i+1)+'</a></li>'
                        }
                        currPage = 0;
                        flushSearch();
                    }
                    else{
                        alert("Problem retrieving XML data:" + this.status);
                    }
                }
            }
        }
    </script>

	<head>
		<meta http-equiv="Access-Control-Allow-Origin" content="*" charset="utf-8">
		<title>搜索引擎</title>
        <style>
            #rightup{
                width: 150px;
                height: 200px;
                position: absolute;
                top:0px;
                right:15px;
            }
            #usrName{
                color: red;
                position: absolute;
                top:0px;
                right:0px;
            }
            #api{
                position: absolute;
                top: 20;
                right: 0;
                width: 110px;
            }
            #login{
                position: absolute;
                right: 0;
            }
            #register{
                margin-left: 0px;
            }
            #rightupBox{
                position: absolute;
                top: 50;
                right: 0;
                display:none;
            }
            #cancelBtn{
                width: 50%;
                float: right;
            }
            #loginBtn{
                width: 50%;
                float: right;
            }
            #right{
                border-left: 1px solid #000;
                width: 450px;
                height: 750px;
                position: absolute;
                top:150px;
                right:15px;
            }
            #tophot{
                /* border: #ee3514; */
                position: absolute;
                top: 0;
                right:15px;
                width: 400;
                height: 300;
            }
            #collection{
                /* border: 1px solid #2a14ee; */
                position: absolute;
                top: 350;
                right:15px;
                width: 400;
                height: 400;
                display: none;
            }
            #collectionHead{
                width: 180;
                color: blue;
                /* font-size: 20; */
            }
            #collectionBack{
                position: absolute;
                top:0;
                right: 160;
                display: none;
            }
            #collectionBtn{
                position: absolute;
                top:0;
                right: 115;
            }
            #collectionAddText{
                position: absolute;
                top:3;
                right: 5;
                display: block;
            }
            ul.pagination {
                display: inline-block;
                padding: 0;
                margin: 0;
            }
            
            ul.pagination li {display: inline;}
            
            ul.pagination li a {
                color: black;
                float: left;
                padding: 8px 16px;
                text-decoration: none;
                transition: background-color .3s;
                border: 1px solid #ddd;
                margin: 0 4px;
            }
            ul.pagination li a.active {
                background-color: #2c73c5;
                color: white;
                border: 1px solid #2c73c5;
            }
            ul.pagination li a:hover:not(.active) {background-color: #ddd;}
            


        </style>
	</head>

	<body>
        <div id="rightup">
            <div id="usrName"><a >未登录</a><br></div>
            <div id="api">
                <a id="register" onclick="showRightUpBox(this.id)">注册</a>
                <a id="login" onclick="showRightUpBox(this.id)">登录</a>
            </div>
            <div id="rightupBox">
                <div class="login-item"><input type="test" id="inputUserName" placeholder="输入用户名" onkeyup="loginOrQuit()" size="11"/></div>
                <div class="login-item"><input type="password" id="inputPWD" placeholder="输入密码"  size="11"/></div>

                <div class="login-item"><input type="submit" id="cancelBtn" value="取消" size="2" onclick="cancelLogin()"/></div>
                <div class="login-item"><input type="submit" id="loginBtn" value="注册" size="2" onclick="login()"/></div>
            </div>
        </div>
		<img src="./logo.png" width="200" height="50" />
        <br>

		<input id="input" type="text" name="target" size="40">
		<input type="submit" value="搜索" size="40" onclick="searching()">


		<form id="selectMethod">
			<input type="radio" name="searchMethod" onclick="updateMethod(this.value)" value="default" checked>文本搜索
			<input type="radio" name="searchMethod" onclick="updateMethod(this.value)" value="set">以图搜图
		</form>
        <hr>
        <div id="right">
            <div id="tophot"><b style="color: rgb(236, 118, 6)">访问热榜</b><hr style="background-color: rgb(236, 118, 6);height: 1px; border: none;"></div>
            <div id="collection">
                <div>
                    <div id="collectionHead"><b>收藏夹列表</b></div>
                    <input id="collectionBack" type="submit" value="后退" onclick="favBack()">
                    <input id="collectionBtn" type="submit" value="添加" onclick="addFav()">
                    <input id="collectionAddText" type="input" value="" placeholder="新的收藏夹名" size="10">
                </div>
                <hr style="background-color: #2a14ee;height: 1px; border: none;">
                <hr style="background-color: #2a14ee;height: 1px; border: none;">
                <div id="collectionInner" style="height: 350px;"></div>
            </div>
        </div>
		<div id="content" style="width:700px; height:800px"></div>
        <ul id="pagelist" class="pagination"></ul>

        <p></p>
		
        <div id="footer" style="background-color:#FFA500;clear:both;text-align:center;">
		版权 © 队名
        </div>
	</body>
</html>